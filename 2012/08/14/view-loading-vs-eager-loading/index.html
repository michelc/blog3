<!doctype html>
<html lang="fr-FR">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>View Loading vs Eager loading - blog.pagesd.info</title>
    <link rel="shortcut icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="alternate" href="/atom.xml" title="blog.pagesd.info" type="application/atom+xml">
    <meta name="author" content="Michel" />
<link rel="canonical" href="https://blog.pagesd.info/2012/08/14/view-loading-vs-eager-loading/" />
<meta property="og:title" content="View Loading vs Eager loading" />
<meta property="og:locale" content="fr-FR" />
<meta property="og:url" content="https://blog.pagesd.info/2012/08/14/view-loading-vs-eager-loading/" />
<meta property="og:site_name" content="blog.pagesd.info" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-08-14T16:33:00.000Z" />
<script type="application/ld+json">{"headline":"blog.pagesd.info","dateModified":"2012-08-14T16:33:00.000Z","datePublished":"2012-08-14T16:33:00.000Z","inLanguage":"fr-FR","url":"https://blog.pagesd.info/2012/08/14/view-loading-vs-eager-loading/","@type":"BlogPosting","image":"","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.pagesd.info/2012/08/14/view-loading-vs-eager-loading/"},"author":{"@type":"Person","name":"Michel"},"@context":"https://schema.org"}</script>
  </head>

  <body><div class="container">

    <header><nav>
      <a class="title" href="/">blog.pagesd.info</a>
      // <a href="/archives/">archives</a>
      // <a href="/traductions/">traductions</a>
    </nav></header>



<article>



  <header>
    <h1>
      <a href="/2012/08/14/view-loading-vs-eager-loading/">View Loading vs Eager loading</a>
    </h1>
    <p>
      <span>2012-08-14</span>
      <span>#ef</span><span>#linq</span><span>#mvc</span><span>#sql</span>
    </p>
  </header>

  <div>

<p>Je travaille sur un projet personnel où j'ai le modèle suivant :</p>
<pre><code>public class Travel
{
    // dentifiant automatique du voyage
    [Key]
    public int TravelID { get; set; }

    // Titre du voyage
    [Required]
    [Display(Name = &quot;Titre&quot;)]
    [StringLength(100)]
    public string Title { get; set; }

    // Type du voyage : journée ou séjour
    [Required]
    [Display(Name = &quot;Type de voyage&quot;)]
    public TravelType TypeTravel
    {
        get { return (TravelType)TravelType; }
        set { TravelType = (int)value; }
    }
    public int TravelType { get; set; }

    // Commentaire sur ce voyage
    [Display(Name = &quot;Remarques&quot;)]
    [Column(TypeName = &quot;ntext&quot;)]
    [DataType(DataType.MultilineText)]
    public string Notes { get; set; }

    // Tarifs du voyage
    public virtual ICollection&lt;Price&gt; Prices { get; set; }
}

public class Price
{
    // Identifiant automatique du tarif
    [Key]
    public int PriceID { get; set; }

    // Référence du voyage auquel correspond le tarif
    [Display(Name = &quot;Voyage&quot;)]
    public int TravelID { get; set; }
    public virtual Travel Travel { get; set; }

    // Année du tarif
    [Required]
    [Display(Name = &quot;Année&quot;)]
    [StringLength(20)]
    public string Year { get; set; }

    // Libellé pour décrire le tarif
    [Required]
    [Display(Name = &quot;Titre&quot;)]
    [StringLength(50)]
    public string Title { get; set; }

    // Prix du voyage pour un groupe de 40 à 44 personnes
    [Display(Name = &quot;Tarif 40 à 44 personnes&quot;)]
    public float Price1 { get; set; }

    // Prix du voyage pour un groupe de 45 à 49 personnes
    [Display(Name = &quot;Tarif 45 à 49 personnes&quot;)]
    public float Price2 { get; set; }

    // Prix du voyage pour un groupe de 50 à 55 personnes
    [Display(Name = &quot;Tarif 50 à 55 personnes&quot;)]
    public float Price3 { get; set; }

    // Commentaire sur ce tarif
    [Display(Name = &quot;Remarques&quot;)]
    [Column(TypeName = &quot;ntext&quot;)]
    [DataType(DataType.MultilineText)]
    public string Notes { get; set; }
}
</code></pre>
<p>Jusqu'à présent, j'utilisais le code suivant pour afficher le détail du prix
d'un voyage :</p>
<pre><code>var price = db.Prices.Find(id);
</code></pre>
<p>Cela a pour effet d'exécuter la requête SQL suivante :</p>
<pre><code>SELECT
[Limit1].[PriceID] AS [PriceID],
[Limit1].[TravelID] AS [TravelID],
[Limit1].[Year] AS [Year],
[Limit1].[Title] AS [Title],
[Limit1].[Price1] AS [Price1],
[Limit1].[Price2] AS [Price2],
[Limit1].[Price3] AS [Price3],
[Limit1].[Notes] AS [Notes]
FROM ( SELECT TOP (2)
        [Extent1].[PriceID] AS [PriceID],
        [Extent1].[TravelID] AS [TravelID],
        [Extent1].[Year] AS [Year],
        [Extent1].[Title] AS [Title],
        [Extent1].[Price1] AS [Price1],
        [Extent1].[Price2] AS [Price2],
        [Extent1].[Price3] AS [Price3],
        [Extent1].[Notes] AS [Notes]
        FROM [Prices] AS [Extent1]
        WHERE [Extent1].[PriceID] = @p0)  AS [Limit1]
</code></pre>
<p><em>Note : Il y a un article sur StackOverflow qui
explique <a href="http://stackoverflow.com/a/7823952/17316">Why
does the Entity Framework's DbContext.Find() generate a query with select top
2?</a>.</em></p>
<p>Puis je passais mon objet Travel à la vue chargée d'afficher les
informations sur le prix du voyage :</p>
<pre><code>return View(price);
</code></pre>
<p>Pour que le contenu de cette vue soit plus clair, elle affiche également le
nom du voyage via la propriété price.Travel.Title, ce qui a pour effet
d'exécuter une requête SQL supplémentaire pour charger le voyage :</p>
<pre><code>SELECT
[Extent1].[TravelID] AS [TravelID],
[Extent1].[Position] AS [Position],
[Extent1].[Title] AS [Title],
[Extent1].[TravelType] AS [TravelType],
[Extent1].[Notes] AS [Notes]
FROM [Travels] AS [Extent1]
WHERE [Extent1].[TravelID] = @EntityKeyValue1
</code></pre>
<p>Le &quot;problème&quot;, c'est que cette requête se fait au niveau de la vue et que
c'est un peu moyen d'accéder à la base de données depuis une vue (enfin je
crois). J'ai donc cherché un moyen pour l'éviter.</p>
<p>Un truc facile, c'est de charger explicitement le voyage :</p>
<pre><code>var price = db.Prices.Find(id);
price.Travel = db.Travels.Find(price.TravelID);
</code></pre>
<p>On peut aussi faire de l'eager loading, mais c'est un peu surdimensionné par
rapport au problème et ça risque aussi de rendre le code un peu plus compliqué
à comprendre dès qu'on a plusieurs jointures :</p>
<pre><code>var price = db.Prices.Include(t =&gt; t.Travel).Single(t =&gt; t.PriceID == id);
</code></pre>
<blockquote>
<p>If your model has multiple relations, they will all be eager loaded for the
grid. However, we don't eager load for the other actions (Edit, Create, etc.)
because there's no scale problem with those - you're only loading a single
entity, and the code is easier to understand if we use normal lazy loading in
those cases.</p>
<p><a href="http://blog.stevensanderson.com/2011/01/28/mvcscaffolding-one-to-many-relationships/">Eager Loading and SELECT N+1</a></p>
</blockquote>
<p>Au final, la bonne solution serait sans doute de passer par un objet
ViewModel pour ne pas courrir le risque d'accéder à la base de données depuis
la vue.</p>
<pre><code>public class PriceViewModel
{
    public int PriceID { get; set; }
    public string TravelTitle { get; set; }
    public string Year { get; set; }
    public string Title { get; set; }
    public float Price1 { get; set; }
    public float Price2 { get; set; }
    public float Price3 { get; set; }
    public string Notes { get; set; }
}
</code></pre>


  </div>

</article><nav class="paginate">
  <a rel="prev" href="/2012/08/06/utilisation-cdn-jquery-ui/" hreflang="fr-FR">Utilisation d&#39;un CDN pour jQuery UI</a>
  <a rel="next" href="/2012/08/22/migrer-repository-mercurial-git/" hreflang="fr-FR">Migrer un repository de Mercurial vers Git</a>
</nav>



<div class="pub"><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5475403929650645"
     data-ad-slot="8049019520"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins></div>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>


    <footer>
      <a href="/">blog.pagesd.info</a> //
      <a href="https://www.solitaire-play.com/">www.solitaire-play.com</a>
    </footer>

  </div>
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5475403929650645"
     crossorigin="anonymous"></script>
  </body>

</html>

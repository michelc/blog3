<!doctype html>
<html lang="fr-FR">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gérer des clés étrangères avec SQLite - blog.pagesd.info</title>
    <link rel="shortcut icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="alternate" href="/atom.xml" title="blog.pagesd.info" type="application/atom+xml">
    <meta name="author" content="Michel" />
<link rel="canonical" href="https://blog.pagesd.info/2023/08/16/sqlite-cles-etrangeres/" />
<meta property="og:title" content="Gérer des clés étrangères avec SQLite" />
<meta name="description" content="Quelques particularités auxquelles il faut penser pour gérer des clés étrangères avec SQLite et C#" />
<meta property="og:description" content="Quelques particularités auxquelles il faut penser pour gérer des clés étrangères avec SQLite et C#" />
<meta property="og:locale" content="fr-FR" />
<meta property="og:url" content="https://blog.pagesd.info/2023/08/16/sqlite-cles-etrangeres/" />
<meta property="og:site_name" content="blog.pagesd.info" />
<meta property="og:type" content="article" />
<meta property="og:image" content="https://blog.pagesd.info/public/2023/sqlite-foreign-keys.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="article:published_time" content="2023-08-16T17:08:22.000Z" />
<script type="application/ld+json">{"headline":"blog.pagesd.info","dateModified":"2023-08-16T17:08:22.000Z","datePublished":"2023-08-16T17:08:22.000Z","description":"Quelques particularités auxquelles il faut penser pour gérer des clés étrangères avec SQLite et C#","inLanguage":"fr-FR","url":"https://blog.pagesd.info/2023/08/16/sqlite-cles-etrangeres/","@type":"BlogPosting","image":"https://blog.pagesd.info/public/2023/sqlite-foreign-keys.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.pagesd.info/2023/08/16/sqlite-cles-etrangeres/"},"author":{"@type":"Person","name":"Michel"},"@context":"https://schema.org"}</script>
  </head>

  <body><div class="container">

    <header><nav>
      <a class="title" href="/">blog.pagesd.info</a>
      // <a href="/archives/">archives</a>
      // <a href="/traductions/">traductions</a>
    </nav></header>



<article>

<figure class="cover-image"><img src="/public/2023/sqlite-foreign-keys.png" alt="C'est quoi le pire : un index inutile ou une clé étrangère non indexée ?" /><figcaption><a href="https://littlekendra.com/2016/09/22/indexing-foreign-keys-guidelines/">C'est quoi le pire : un index inutile ou une clé étrangère non indexée ?</a></figcaption></figure>

  <header>
    <h1>
      <a href="/2023/08/16/sqlite-cles-etrangeres/">Gérer des clés étrangères avec SQLite</a>
    </h1>
    <p>
      <span>2023-08-16</span>
      <span>#sql</span><span>#csharp</span>
    </p>
  </header>

  <div>

<p>Pour les petits trucs en .NET Core, le plus simple est d'utiliser une base de données <a href="https://www.sqlite.org/">SQLite</a>. Mais si on veut gérer correctement les clés étrangères, il faut penser à tenir compte de quelques particularités, d'où ce billet pour ne pas oublier...</p>
<p>Dans l'exemple qui suit, la clé étrangère permet de décrire la relation entre les deux tables &quot;Blogs&quot; (les parents) et &quot;Posts&quot; (les enfants) et d'assurer l'intégrité des données afin qu'il n'y ait pas d'enfants sans un parent. Toute tentative d'insertion d'une ligne dans la table &quot;Posts&quot; qui ne correspondrait pas à une ligne de la table &quot;Blogs&quot; génèrera une erreur SQL. De la même façon, on provoquera une erreur SQL si on essaie de supprimer une ligne de la table &quot;Blogs&quot; alors qu'il y a des données qui en dépendent dans la table &quot;Posts&quot;.</p>
<pre><code class="language-sql">CREATE TABLE Blogs
(
  Blog_ID     INTEGER PRIMARY KEY,
  Title       TEXT
);

CREATE TABLE Posts
(
  Post_ID     INTEGER PRIMARY KEY,
  Blog_ID     INTEGER,
  Content     TEXT,
  FOREIGN KEY (Blog_ID) REFERENCES Blogs (Blog_ID)
);
</code></pre>
<p>SQLite permet de définir des clés étrangères sans problème. La difficulté c'est que par défaut les contraintes liées aux clés étrangères sont désactivées (pour rester compatible avec les premières versions de SQLite).</p>
<p>Concrètement, ça veut donc dire qu'on peut créer des clés étrangères avec SQLite, mais qu'elles ne servent à rien ! Et donc qu'on pourra sans problème insérer des données sans clé étrangère &quot;parent&quot; ou supprimer des données &quot;parents&quot; pourtant utilisées par des enregistrements &quot;enfants&quot; :(</p>
<p>Heureusement, il est possible d'activer les contraintes liées aux étrangères. On ne peut pas faire cela de façon &quot;globale&quot;, mais uniquement au niveau de la connexion à la base de données. Sous SQlite, on réalise ça avec la commande &quot;PRAGMA&quot; :</p>
<pre><code class="language-sql">sqlite&gt; PRAGMA foreign_keys = ON;
</code></pre>
<p>Avec ADO.NET ou Entity Framework, c'est encore plus simple (ou pas) puisqu'il suffit d'ajouter &quot;Foreign Keys=true&quot; à la chaine de connexion. Ce qui a pour effet d'envoyer automatiquement la commande <code>PRAGMA foreign_keys = 1</code> immédiatement après l'ouverture de la connexion à la base de données.</p>
<p>Grâce à cette modification toute simple, il ne sera plus possible d'ajouter un &quot;enfant&quot; sans référencer un &quot;parent&quot; existant. Ou de supprimer un parent qui a un enfant...</p>
<pre><code class="language-sql">INSERT INTO Blogs (Blog_ID, Title) VALUES (1, 'Mon nouveau blogue');

COMMIT

INSERT INTO Posts (Post_ID, Blog_ID, Content) VALUES (1, 33, 'Mon premier billet');
=&gt; FOREIGN KEY constraint failed

INSERT INTO Posts (Post_ID, Blog_ID, Content) VALUES (1, 1, 'Mon premier billet');

COMMIT

DELETE FROM Blogs WHERE Blog_ID = 1;
=&gt; FOREIGN KEY constraint failed
</code></pre>
<p><strong>Attention</strong> : Avec EF Core, la clause <code>ON DELETE</code> des clés étrangères est définie à <code>CASCADE</code> par défaut... De quoi alimenter un autre billet de blogue !</p>


  </div>

</article><nav class="paginate">
  <a rel="prev" href="/2023/08/14/generer-avatar-csharp/" hreflang="fr-FR">Générer un badge / avatar en C#</a>
</nav>



<div class="pub"><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5475403929650645"
     data-ad-slot="8049019520"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins></div>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>


    <footer>
      <a href="/">blog.pagesd.info</a> //
      <a href="https://www.solitaire-play.com/">www.solitaire-play.com</a>
      <a rel="me" href="https://pouet.chapril.org/@ms_michel"></a>
    </footer>

  </div>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5475403929650645"
     crossorigin="anonymous"></script>
  </body>

</html>

<!doctype html>
<html lang="fr-FR">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Générer un badge / avatar en C# - blog.pagesd.info</title>
    <link rel="shortcut icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="alternate" href="/atom.xml" title="blog.pagesd.info" type="application/atom+xml">
    <meta name="author" content="Michel" />
<link rel="canonical" href="https://blog.pagesd.info/2023/08/14/generer-avatar-csharp/" />
<meta property="og:title" content="Générer un badge / avatar en C#" />
<meta name="description" content="Une méthode simple pour afficher un avatar sans se péoccuper de savoir s&#39;il s&#39;agit d&#39;une image statique ou d&#39;une image dynamique générée en C#." />
<meta property="og:description" content="Une méthode simple pour afficher un avatar sans se péoccuper de savoir s&#39;il s&#39;agit d&#39;une image statique ou d&#39;une image dynamique générée en C#." />
<meta property="og:locale" content="fr-FR" />
<meta property="og:url" content="https://blog.pagesd.info/2023/08/14/generer-avatar-csharp/" />
<meta property="og:site_name" content="blog.pagesd.info" />
<meta property="og:type" content="article" />
<meta property="og:image" content="https://blog.pagesd.info/public/2023/avatars-csharp.png" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="article:published_time" content="2023-08-14T10:07:46.000Z" />
<script type="application/ld+json">{"headline":"blog.pagesd.info","dateModified":"2023-08-14T10:07:46.000Z","datePublished":"2023-08-14T10:07:46.000Z","description":"Une méthode simple pour afficher un avatar sans se péoccuper de savoir s'il s'agit d'une image statique ou d'une image dynamique générée en C#.","inLanguage":"fr-FR","url":"https://blog.pagesd.info/2023/08/14/generer-avatar-csharp/","@type":"BlogPosting","image":"https://blog.pagesd.info/public/2023/avatars-csharp.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.pagesd.info/2023/08/14/generer-avatar-csharp/"},"author":{"@type":"Person","name":"Michel"},"@context":"https://schema.org"}</script>
  </head>

  <body><div class="container">

    <header><nav>
      <a class="title" href="/">blog.pagesd.info</a>
      // <a href="/archives/">archives</a>
      // <a href="/traductions/">traductions</a>
    </nav></header>



<article>

<figure class="cover-image"><img src="/public/2023/avatars-csharp.png" alt="" /><figcaption>&nbsp;</figcaption></figure>

  <header>
    <h1>
      <a href="/2023/08/14/generer-avatar-csharp/">Générer un badge / avatar en C#</a>
    </h1>
    <p>
      <span>2023-08-14</span>
      <span>#csharp</span><span>#.net</span>
    </p>
  </header>

  <div>

<p>J'ai récemment eu besoin d'afficher à nouveau des avatars, et j'ai voulu en profiter pour essayer une autre façon de faire par rapport à ce que j'avais fait il y a 2 ans avec &quot;<a href="/2021/12/10/creer-badge-avatar-css/" hreflang="fr-FR">Créer un badge / avatar en CSS</a>&quot;.</p>
<p>Et donc, plutôt que de faire ça avec du bon vieux code HTML et CSS, je génère automatiquement une image pour les personnes qui n'ont pas de &quot;vrai&quot; avatar.</p>
<h2>Renvoyer une image statique</h2>
<p>Les images des avatars sont stockées dans le dossier &quot;/wwwroot/avatars&quot; pour les cas où il existe un avatar.</p>
<p>Chaque avatar est enregistré en JPG, avec un nom de la forme &quot;trigramme.prenom.nom.jpg&quot;.</p>
<ul>
<li>trigramme = initiale du prénom + initiale du nom + lettre finale du nom (donc 3 lettres au total)</li>
<li>prenom = le prénom en minuscule sans accents, espaces, tirets... de la personne</li>
<li>nom = le nom en minuscule sans accents, espaces, tirets... de la personne</li>
</ul>
<p>Par conséquent, un nom de fichier est composé uniquement des 26 lettres &quot;a&quot; à &quot;z&quot;, avec un &quot;.&quot; pour séparer les différentes parties : &quot;tsk.tony.stark.jpg&quot;, &quot;bbr.bruce.banner.jpg&quot;, &quot;srs.steve.rogers.jpg&quot;, etc...</p>
<p>De cette façon, lorsqu'il existe un &quot;vrai&quot; avatar pour une personne, j'utilise simplement l'URL de l'image &quot;/avatars/tsk.tony.stark.jpg&quot; et le middleware &quot;UseStaticFiles()&quot; renvoie cette image sans chercher plus loin.</p>
<h2>Renvoyer une image dynamique</h2>
<p>Dans les cas où il n'existe pas d'image, j'ai une route qui prend le relai et qui renvoie une image générée à la volée. Ce qui donne au niveau de mon fichier &quot;Program.cs&quot; :</p>
<pre><code class="language-csharp">// Middleware pour les fichiers statiques
// =&gt; renvoie entre autre les images utilisées pour les avatars
app.UseStaticFiles();

...

// Route par défaut pour une application MVC basique
app.MapControllerRoute(
    name: &quot;default&quot;,
    pattern: &quot;{controller=Home}/{action=Index}/{id?}&quot;);

// Route spécifique pour générer des avatars
app.MapControllerRoute(
    name: &quot;avatars&quot;,
    pattern: &quot;/avatars/{id}.jpg&quot;,
    defaults: new { controller = &quot;Avatars&quot;, action = &quot;Index&quot; });
</code></pre>
<p>Puis, dans le contrôleur &quot;AvatarsController.cs&quot;, je n'ai plus qu'à générer une image en fonction de l'identifiant de l'image, à savoir une chaine de la forme &quot;trigramme.prenom.nom.jpg&quot;.</p>
<pre><code class="language-csharp">public ActionResult Index(string id = &quot;&quot;)
{
    var trigramme = id.Substring(0, 3).ToUpper();

    var color = GetColor(trigramme);
    var avatar = GetBitmap(color, trigramme);

    // Convertir l'image en tableau de bytes (byte array)
    using (MemoryStream ms = new MemoryStream())
    {
        avatar.Save(ms, ImageFormat.Jpeg);
        byte[] imageBytes = ms.ToArray();

        // Renvoyer l'image directement comme réponse HTTP avec le type de contenu approprié
        return File(imageBytes, &quot;image/jpg&quot;);
    }
}
</code></pre>
<p>Je commence par récupérer le trigramme de la personne car il va me permettre de générer une couleur de fond pour l'avatar, via la fonction <code>GetColor(trigramme)</code>.</p>
<p>Puis j'appelle la méthode <code>GetImage(color, trigramme)</code> qui est chargée de générer l'image correspondant à l'avatar.</p>
<p>Et enfin, je renvoie cette image au navigateur. Je peux alors utiliser la route de cette image &quot;/avatars/tsk.tony.stark.jpg&quot; exactement comme si c'était un fichier statique.</p>
<h2>Afficher l'avatar</h2>
<p>Côté HTML, je n'ai donc pas à me préoccuper de savoir s'il s'agit d'une image statique ou dynamique et je peux me contenter d'afficher une image basique :</p>
<pre><code class="language-html">&lt;div class=&quot;round-avatar&quot;&gt;
    &lt;img src=&quot;/avatars/@(user.Trigramme).@(user.Prenom).@(user.Nom).jpg&quot; /&gt;
&lt;/div&gt;
</code></pre>
<p>Puis quelques lignes de CSS pour donner un look &quot;fini&quot; à l'avatar :</p>
<pre><code class="language-css">/* Avatars ronds */
.round-avatar img {
    border-radius: 50%;
    height: 64px;
    width: 64px;
}
/* Bordure au survol */
.round-avatar:hover img {
    box-shadow: 0 0 0 4px #fff;
}
</code></pre>
<h2>Générer l'avatar en C#</h2>
<p>La fonction <code>GetColor()</code> est un peu tarabiscotée et me permet de définir une couleur en fonction du trigramme. Je ferais peut-être un autre billet pour expliquer comment je procède...</p>
<p>La fonction <code>GetImage()</code> génère un carré avec le fond de la couleur demandée et les initiales de la personne en blanc. Pour cela, j'utilise <code>System.Drawing</code> de façon assez basique :</p>
<pre><code class="language-csharp">using System.Drawing;
using System.Drawing.Drawing2D;
using System.Drawing.Imaging;
...

private Bitmap GetBitmap (Color color, string trigramme)
{
    // Créer une image avec le fond de la couleur demandée
    var image = new Bitmap(400, 400);
    using (Graphics gfx = Graphics.FromImage(image))
    {
        gfx.SmoothingMode = SmoothingMode.AntiAlias;
        gfx.Clear(color);
    }

    // Ajouter les 2 initiales du trigramme centré au milieu de l'image
    using (Graphics gfx = Graphics.FromImage(image))
    {
        Font font = new Font(&quot;Calibri&quot;, 128, FontStyle.Bold);
        Brush brush = new SolidBrush(Color.White);
        StringFormat format = new StringFormat();
        format.Alignment = StringAlignment.Center;
        format.LineAlignment = StringAlignment.Center;

        gfx.DrawString(trigramme.Substring(0, 2), font, brush, new Rectangle(0, 0, 400, 400), format);
    }

    // Renvoie l'image générée
    return image;
}
</code></pre>
<h2>Conclusion</h2>
<p>C'était pas très compliqué à coder et c'est amusant d'avoir un truc simple capable d'afficher des avatars sans avoir à faire la distinction entre les personnes pour lesquelles il existe un &quot;vrai&quot; avatar et celles pour lesquelles il n'y en a pas.</p>


  </div>

</article><nav class="paginate">
  <a rel="prev" href="/2023/01/17/array-every-new-set-sauvent-lemot/" hreflang="fr-FR">Array.every() et new Set() sauvent LeMOT</a>
  <a rel="next" href="/2023/08/16/sqlite-cles-etrangeres/" hreflang="fr-FR">Gérer des clés étrangères avec SQLite</a>
</nav>



<div class="pub"><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5475403929650645"
     data-ad-slot="8049019520"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins></div>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>


    <footer>
      <a href="/">blog.pagesd.info</a> //
      <a href="https://www.solitaire-play.com/">www.solitaire-play.com</a>
      <a rel="me" href="https://pouet.chapril.org/@ms_michel"></a>
    </footer>

  </div>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5475403929650645"
     crossorigin="anonymous"></script>
  </body>

</html>
